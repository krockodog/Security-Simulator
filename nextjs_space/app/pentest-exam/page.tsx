'use client'

import { useState, useEffect, useMemo } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import { Label } from '@/components/ui/label'
import { Progress } from '@/components/ui/progress'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { ArrowLeft, Clock, AlertCircle } from 'lucide-react'
import { pt003MultipleChoiceQuestions } from '@/lib/pt003-data'

export default function PentestExamPage() {
  const [userName, setUserName] = useState('Kandidat')
  const [examStarted, setExamStarted] = useState(false)
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0)
  const [userAnswers, setUserAnswers] = useState<{ [key: number]: number }>({})
  const [timeLeft, setTimeLeft] = useState(165 * 60) // 165 minutes in seconds
  const [showResults, setShowResults] = useState(false)

  const examQuestions = pt003MultipleChoiceQuestions

  useEffect(() => {
    const name = localStorage.getItem('userName')
    if (name) setUserName(name)
  }, [])

  useEffect(() => {
    if (examStarted && !showResults && timeLeft > 0) {
      const timer = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            setShowResults(true)
            return 0
          }
          return prev - 1
        })
      }, 1000)
      return () => clearInterval(timer)
    }
  }, [examStarted, showResults, timeLeft])

  const formatTime = (seconds: number) => {
    const hours = Math.floor(seconds / 3600)
    const minutes = Math.floor((seconds % 3600) / 60)
    const secs = seconds % 60
    return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`
  }

  const currentQuestion = examQuestions[currentQuestionIndex]
  const progress = ((currentQuestionIndex + 1) / examQuestions.length) * 100
  const answeredCount = Object.keys(userAnswers).length

  const handleAnswerSelect = (optionIndex: number) => {
    setUserAnswers(prev => ({
      ...prev,
      [currentQuestionIndex]: optionIndex
    }))
  }

  const handleNext = () => {
    if (currentQuestionIndex < examQuestions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1)
    }
  }

  const handlePrevious = () => {
    if (currentQuestionIndex > 0) {
      setCurrentQuestionIndex(prev => prev - 1)
    }
  }

  const handleSubmit = () => {
    setShowResults(true)
  }

  const calculateResults = () => {
    let correct = 0
    examQuestions.forEach((q, idx) => {
      if (userAnswers[idx] === q.correctAnswer) {
        correct++
      }
    })
    const percentage = (correct / examQuestions.length) * 100
    const passed = percentage >= 72 // PT0-003 passing score is 72%
    return { correct, total: examQuestions.length, percentage, passed }
  }

  if (!examStarted) {
    return (
      <div className="min-h-screen bg-black cyber-grid flex items-center justify-center px-4">
        <div className="max-w-3xl mx-auto">
          <Card className="cyber-card shadow-2xl">
            <CardHeader className="text-center border-b border-[rgb(var(--cyber-border))]">
              <CardTitle className="text-3xl mb-2 text-readable">CompTIA PenTest+ PT0-003</CardTitle>
              <CardDescription className="text-readable-dim">Pr√ºfungssimulator</CardDescription>
            </CardHeader>
            <CardContent className="pt-6">
              <div className="space-y-6">
                <div className="text-center">
                  <p className="text-xl text-readable mb-2">Willkommen, {userName}!</p>
                  <p className="text-readable-dim">Bereit f√ºr die Pr√ºfung?</p>
                </div>

                <Alert className="border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))]">
                  <AlertCircle className="h-4 w-4 text-[rgb(var(--cyber-cyan))]" />
                  <AlertDescription className="text-readable-dim">
                    <ul className="list-disc list-inside space-y-2">
                      <li>Anzahl der Fragen: {examQuestions.length}</li>
                      <li>Zeitlimit: 165 Minuten</li>
                      <li>Passing Score: 72%</li>
                      <li>Format: Single Choice</li>
                    </ul>
                  </AlertDescription>
                </Alert>

                <Button
                  onClick={() => setExamStarted(true)}
                  className="w-full cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable"
                  size="lg"
                >
                  Pr√ºfung starten
                </Button>

                <Link
                  href="/pentest-plus"
                  className="block text-center text-[rgb(var(--cyber-cyan))] hover:text-[rgb(var(--cyber-magenta))] transition-colors"
                >
                  Zur√ºck zum Dashboard
                </Link>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    )
  }

  if (showResults) {
    const results = calculateResults()
    return (
      <div className="min-h-screen bg-black cyber-grid py-8 px-4">
        <div className="max-w-4xl mx-auto">
          <Card className="cyber-card shadow-2xl">
            <CardHeader className={`text-center border-b ${
              results.passed
                ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                : 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
            }`}>
              <CardTitle className="text-3xl mb-2 text-readable">
                {results.passed ? 'üéâ Bestanden!' : '‚ùå Nicht bestanden'}
              </CardTitle>
              <CardDescription className="text-xl font-bold text-readable">
                {results.percentage.toFixed(1)}% ({results.correct}/{results.total})
              </CardDescription>
            </CardHeader>
            <CardContent className="pt-6">
              <div className="space-y-6">
                <div className="text-center">
                  <p className="text-lg text-readable-dim">
                    {results.passed
                      ? 'Herzlichen Gl√ºckwunsch! Du hast die Pr√ºfung bestanden.'
                      : `Du ben√∂tigst mindestens 72% zum Bestehen. Versuche es nochmal!`}
                  </p>
                </div>

                <div className="border-t border-[rgb(var(--cyber-border))] pt-6">
                  <h3 className="text-xl font-semibold text-readable mb-4">Detaillierte Ergebnisse</h3>
                  <div className="space-y-4">
                    {examQuestions.map((q, idx) => {
                      const userAnswer = userAnswers[idx]
                      const isCorrect = userAnswer === q.correctAnswer
                      return (
                        <div key={idx} className={`p-4 rounded border ${
                          isCorrect
                            ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.03)]'
                            : userAnswer !== undefined
                            ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.03)]'
                            : 'border-[rgb(var(--cyber-border))]'
                        }`}>
                          <div className="flex items-start gap-3">
                            <span className="font-bold text-readable">{idx + 1}.</span>
                            <div className="flex-1">
                              <p className="text-readable mb-2">{q.questionEN}</p>
                              <p className="text-sm text-readable-dim">
                                <span className="font-medium">Deine Antwort:</span>{' '}
                                {userAnswer !== undefined ? q.options[userAnswer] : 'Nicht beantwortet'}
                              </p>
                              {!isCorrect && (
                                <p className="text-sm text-[rgb(var(--cyber-success))] mt-1">
                                  <span className="font-medium">Richtig:</span> {q.options[q.correctAnswer]}
                                </p>
                              )}
                              <p className="text-sm text-readable-dim mt-2">{q.explanationEN}</p>
                            </div>
                          </div>
                        </div>
                      )
                    })}
                  </div>
                </div>

                <div className="flex gap-4 justify-center pt-6">
                  <Button
                    onClick={() => {
                      setExamStarted(false)
                      setShowResults(false)
                      setUserAnswers({})
                      setCurrentQuestionIndex(0)
                      setTimeLeft(165 * 60)
                    }}
                    className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable"
                  >
                    Neu starten
                  </Button>
                  <Link href="/pentest-plus">
                    <Button className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable">
                      Zur√ºck zum Dashboard
                    </Button>
                  </Link>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-black cyber-grid py-8 px-4">
      <div className="max-w-5xl mx-auto">
        {/* Header mit Timer */}
        <div className="mb-6 flex items-center justify-between">
          <Link href="/pentest-plus" className="text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] transition-colors">
            <ArrowLeft className="h-4 w-4 inline mr-2" />
            Pr√ºfung abbrechen
          </Link>
          <div className="flex items-center gap-2">
            <Clock className={`h-5 w-5 ${
              timeLeft < 300 ? 'text-[rgb(var(--cyber-error))]' : 'text-[rgb(var(--cyber-cyan))]'
            }`} />
            <span className={`text-lg font-mono ${
              timeLeft < 300 ? 'text-[rgb(var(--cyber-error))]' : 'text-readable'
            }`}>
              {formatTime(timeLeft)}
            </span>
          </div>
        </div>

        {/* Progress Bar */}
        <div className="mb-6">
          <div className="flex justify-between text-sm text-readable-dim mb-2">
            <span>Frage {currentQuestionIndex + 1} von {examQuestions.length}</span>
            <span>Beantwortet: {answeredCount}/{examQuestions.length}</span>
          </div>
          <Progress value={progress} className="h-2" />
        </div>

        {/* Question Card */}
        <Card className="cyber-card mb-6">
          <CardHeader>
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="text-sm text-[rgb(var(--cyber-cyan))] mb-2">
                  Domain: {currentQuestion.domain}
                </div>
                <CardTitle className="text-xl text-readable">
                  {currentQuestion.questionEN}
                </CardTitle>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <RadioGroup
              value={userAnswers[currentQuestionIndex]?.toString()}
              onValueChange={(value) => handleAnswerSelect(parseInt(value))}
            >
              <div className="space-y-3">
                {currentQuestion.options.map((option, idx) => (
                  <div key={idx} className="flex items-start space-x-3 p-3 rounded border border-[rgb(var(--cyber-border))] hover:border-[rgb(var(--cyber-cyan))] transition-colors">
                    <RadioGroupItem value={idx.toString()} id={`option-${idx}`} className="mt-1" />
                    <Label htmlFor={`option-${idx}`} className="flex-1 cursor-pointer text-readable">
                      {option}
                    </Label>
                  </div>
                ))}
              </div>
            </RadioGroup>
          </CardContent>
        </Card>

        {/* Navigation Buttons */}
        <div className="flex justify-between items-center">
          <Button
            onClick={handlePrevious}
            disabled={currentQuestionIndex === 0}
            variant="outline"
            className="border-[rgb(var(--cyber-border))] text-readable"
          >
            Zur√ºck
          </Button>

          <div className="flex gap-3">
            {currentQuestionIndex === examQuestions.length - 1 ? (
              <Button
                onClick={handleSubmit}
                className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              >
                Pr√ºfung abschlie√üen
              </Button>
            ) : (
              <Button
                onClick={handleNext}
                className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              >
                N√§chste Frage
              </Button>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}
