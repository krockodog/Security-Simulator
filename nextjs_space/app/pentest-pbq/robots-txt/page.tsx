'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { ArrowLeft, AlertCircle, CheckCircle2, XCircle, FileText } from 'lucide-react'
import { robotsTxtScenario, robotsTxtQuestions } from '@/lib/pt003-data'

export default function RobotsTxtPBQ() {
  const [userAnswers, setUserAnswers] = useState<{[key: string]: string | string[]}>({})
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const handleAnswerChange = (questionId: string, answer: string | string[]) => {
    setUserAnswers(prev => ({ ...prev, [questionId]: answer }))
  }

  const handleSubmit = () => {
    let totalPoints = 0
    let earnedPoints = 0

    robotsTxtQuestions.forEach(question => {
      const userAnswer = userAnswers[question.id]
      
      if (Array.isArray(question.correctAnswer)) {
        totalPoints += question.correctAnswer.length
        if (Array.isArray(userAnswer)) {
          question.correctAnswer.forEach(correct => {
            if (userAnswer.includes(correct)) earnedPoints++
          })
        }
      } else {
        totalPoints++
        if (userAnswer === question.correctAnswer) earnedPoints++
      }
    })

    setScore(Math.round((earnedPoints / totalPoints) * 100))
    setSubmitted(true)
  }

  const handleReset = () => {
    setUserAnswers({})
    setSubmitted(false)
    setScore(0)
  }

  const allAnswered = robotsTxtQuestions.every(q => userAnswers[q.id])

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 7: {robotsTxtScenario.title}</h1>
          <p className="text-readable-dim text-lg">Reconnaissance & Information Disclosure</p>
        </div>

        <Card className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/20 mb-6">
          <CardHeader>
            <CardTitle className="text-[rgb(var(--cyber-cyan))] flex items-center gap-2">
              <FileText className="h-5 w-5" />
              Szenario
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <pre className="text-readable-dim bg-[rgb(var(--cyber-surface-light))] p-4 rounded border border-[rgb(var(--cyber-cyan))]/20 overflow-x-auto">
{robotsTxtScenario.scenario}
            </pre>
            <Alert className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
              <FileText className="h-4 w-4" />
              <AlertTitle className="text-[rgb(var(--cyber-cyan))]">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {robotsTxtScenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        <div className="space-y-6 mb-8">
          {robotsTxtQuestions.map((question, idx) => {
            const isMultiSelect = question.type === 'entry_removal'
            const correctAnswers = Array.isArray(question.correctAnswer) ? question.correctAnswer : [question.correctAnswer]
            const userAnswer = userAnswers[question.id]
            const userAnswersArray = Array.isArray(userAnswer) ? userAnswer : (userAnswer ? [userAnswer] : [])
            
            let isCorrect = false
            let isPartiallyCorrect = false
            
            if (submitted) {
              if (isMultiSelect && Array.isArray(userAnswer)) {
                const correctCount = userAnswer.filter((ans: string) => correctAnswers.includes(ans)).length
                isCorrect = correctCount === correctAnswers.length && userAnswer.length === correctAnswers.length
                isPartiallyCorrect = correctCount > 0 && !isCorrect
              } else {
                isCorrect = userAnswer === question.correctAnswer
              }
            }

            return (
              <Card 
                key={question.id}
                className={`bg-[rgb(var(--cyber-surface))] transition-all ${
                  isCorrect ? 'border-green-500/50 bg-green-500/5' : 
                  isPartiallyCorrect ? 'border-amber-500/50 bg-amber-500/5' :
                  submitted && userAnswer ? 'border-red-500/50 bg-red-500/5' : 
                  'border-[rgb(var(--cyber-cyan))]/20'
                }`}
              >
                <CardHeader>
                  <CardTitle className="text-readable text-lg flex items-center gap-2">
                    {isCorrect && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {isPartiallyCorrect && <AlertCircle className="h-5 w-5 text-amber-500" />}
                    {submitted && !isCorrect && !isPartiallyCorrect && userAnswer && <XCircle className="h-5 w-5 text-red-500" />}
                    Frage {idx + 1}
                  </CardTitle>
                  <CardDescription className="text-readable-dim">{question.question}</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  {isMultiSelect ? (
                    <div className="space-y-2">
                      <p className="text-sm text-readable-dim">Wähle {correctAnswers.length} korrekte Antworten:</p>
                      {question.options.map((option) => {
                        const isSelected = userAnswersArray.includes(option)
                        return (
                          <label key={option} className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={isSelected}
                              disabled={submitted}
                              onChange={(e) => {
                                const currentAnswers = Array.isArray(userAnswers[question.id]) ? userAnswers[question.id] as string[] : []
                                const newAnswers = e.target.checked
                                  ? [...currentAnswers, option]
                                  : currentAnswers.filter((a: string) => a !== option)
                                handleAnswerChange(question.id, newAnswers)
                              }}
                              className="form-checkbox h-4 w-4 text-[rgb(var(--cyber-cyan))] bg-[rgb(var(--cyber-surface-light))] border-[rgb(var(--cyber-cyan))]/30 rounded"
                            />
                            <span className="text-readable">{option}</span>
                          </label>
                        )
                      })}
                    </div>
                  ) : (
                    <Select
                      value={userAnswers[question.id] as string || ''}
                      onValueChange={(value) => handleAnswerChange(question.id, value)}
                      disabled={submitted}
                    >
                      <SelectTrigger className="w-full bg-[rgb(var(--cyber-surface-light))] border-[rgb(var(--cyber-cyan))]/30 text-readable">
                        <SelectValue placeholder="Wähle eine Antwort..." />
                      </SelectTrigger>
                      <SelectContent className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
                        {question.options.map((option) => (
                          <SelectItem key={option} value={option} className="text-readable">
                            {option}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  )}

                  {submitted && (
                    <Alert className={`${
                      isCorrect ? 'bg-green-500/10 border-green-500/50' : 'bg-amber-500/10 border-amber-500/50'
                    }`}>
                      <AlertCircle className={`h-4 w-4 ${isCorrect ? 'text-green-500' : 'text-amber-500'}`} />
                      <AlertTitle className={isCorrect ? 'text-green-500' : 'text-amber-500'}>
                        {isCorrect ? 'Richtig!' : 'Erklärung'}
                      </AlertTitle>
                      <AlertDescription className="text-readable-dim space-y-2">
                        <p><strong>Richtige Antwort(en):</strong></p>
                        {correctAnswers.map((ans, i) => (
                          <div key={i}><code className="text-[rgb(var(--cyber-cyan))]">{ans}</code></div>
                        ))}
                        <p className="mt-2"><strong>Erklärung:</strong> {question.explanation}</p>
                      </AlertDescription>
                    </Alert>
                  )}
                </CardContent>
              </Card>
            )
          })}
        </div>

        {!submitted ? (
          <div className="flex gap-4">
            <Button
              onClick={handleSubmit}
              disabled={!allAnswered}
              className="flex-1 bg-gradient-to-r from-[rgb(var(--cyber-cyan))] to-[rgb(var(--cyber-magenta))] text-black font-semibold hover:opacity-90"
            >
              AUSWERTUNG ANZEIGEN
            </Button>
            <Button
              onClick={handleReset}
              className="bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Zurücksetzen
            </Button>
          </div>
        ) : (
          <div className="space-y-6">
            <Card className="bg-gradient-to-br from-[rgb(var(--cyber-cyan))]/10 to-[rgb(var(--cyber-magenta))]/10 border-[rgb(var(--cyber-cyan))]/30">
              <CardHeader>
                <CardTitle className="text-3xl text-[rgb(var(--cyber-cyan))]">Ergebnis: {score}%</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-readable-dim text-lg">
                  Robots.txt Analysis abgeschlossen. Review die Erklärungen oben für jede Frage.
                </p>
              </CardContent>
            </Card>

            <Button
              onClick={handleReset}
              className="w-full bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Erneut versuchen
            </Button>
          </div>
        )}
      </div>
    </div>
  )
}
