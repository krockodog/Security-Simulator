'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { ArrowLeft, AlertCircle, CheckCircle2, XCircle, Code } from 'lucide-react'
import { domXssScenario, domXssExploits } from '@/lib/pt003-data'

export default function DomXssPBQ() {
  const [userAnswers, setUserAnswers] = useState<{[key: string]: string}>({})
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const handleAnswerChange = (exploitId: string, answer: string) => {
    setUserAnswers(prev => ({ ...prev, [exploitId]: answer }))
  }

  const handleSubmit = () => {
    let correct = 0
    domXssExploits.forEach(exploit => {
      if (userAnswers[exploit.id] === exploit.payload) {
        correct++
      }
    })
    setScore(Math.round((correct / domXssExploits.length) * 100))
    setSubmitted(true)
  }

  const handleReset = () => {
    setUserAnswers({})
    setSubmitted(false)
    setScore(0)
  }

  const allAnswered = domXssExploits.every(exploit => userAnswers[exploit.id])

  // Extract unique payloads for dropdown
  const allPayloads = Array.from(new Set(domXssExploits.map(e => e.payload)))

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 8: {domXssScenario.title}</h1>
          <p className="text-readable-dim text-lg">Client-Side XSS Exploitation</p>
        </div>

        <Card className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/20 mb-6">
          <CardHeader>
            <CardTitle className="text-[rgb(var(--cyber-cyan))] flex items-center gap-2">
              <Code className="h-5 w-5" />
              Szenario
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <pre className="text-readable-dim bg-[rgb(var(--cyber-surface-light))] p-4 rounded border border-[rgb(var(--cyber-cyan))]/20 overflow-x-auto text-sm">
{domXssScenario.scenario}
            </pre>
            <Alert className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
              <Code className="h-4 w-4" />
              <AlertTitle className="text-[rgb(var(--cyber-cyan))]">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {domXssScenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        <div className="space-y-6 mb-8">
          {domXssExploits.map((exploit, idx) => {
            const isCorrect = submitted && userAnswers[exploit.id] === exploit.payload
            const isWrong = submitted && userAnswers[exploit.id] && userAnswers[exploit.id] !== exploit.payload

            return (
              <Card 
                key={exploit.id}
                className={`bg-[rgb(var(--cyber-surface))] transition-all ${
                  isCorrect ? 'border-green-500/50 bg-green-500/5' : 
                  isWrong ? 'border-red-500/50 bg-red-500/5' : 
                  'border-[rgb(var(--cyber-cyan))]/20'
                }`}
              >
                <CardHeader>
                  <CardTitle className="text-readable text-lg flex items-center gap-2">
                    {isCorrect && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {isWrong && <XCircle className="h-5 w-5 text-red-500" />}
                    Exploit {idx + 1}: {exploit.vulnerability}
                  </CardTitle>
                  <CardDescription className="text-readable-dim break-all">
                    <strong>Exploit URL:</strong> {exploit.exploitUrl}
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Select
                    value={userAnswers[exploit.id] || ''}
                    onValueChange={(value) => handleAnswerChange(exploit.id, value)}
                    disabled={submitted}
                  >
                    <SelectTrigger className="w-full bg-[rgb(var(--cyber-surface-light))] border-[rgb(var(--cyber-cyan))]/30 text-readable">
                      <SelectValue placeholder="Wähle Payload..." />
                    </SelectTrigger>
                    <SelectContent className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30 max-h-96">
                      {allPayloads.map((payload) => (
                        <SelectItem key={payload} value={payload} className="text-readable">
                          <code className="text-xs text-[rgb(var(--cyber-cyan))] break-all">{payload}</code>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>

                  {submitted && (
                    <Alert className={`${
                      isCorrect ? 'bg-green-500/10 border-green-500/50' : 'bg-amber-500/10 border-amber-500/50'
                    }`}>
                      <AlertCircle className={`h-4 w-4 ${isCorrect ? 'text-green-500' : 'text-amber-500'}`} />
                      <AlertTitle className={isCorrect ? 'text-green-500' : 'text-amber-500'}>
                        {isCorrect ? 'Richtig!' : 'Erklärung'}
                      </AlertTitle>
                      <AlertDescription className="text-readable-dim space-y-2">
                        <div>
                          <p><strong>Richtiger Payload:</strong></p>
                          <code className="text-xs text-[rgb(var(--cyber-cyan))] bg-[rgb(var(--cyber-surface-light))] p-2 rounded block mt-1 break-all">{exploit.payload}</code>
                        </div>
                        <p><strong>Impact:</strong> {exploit.impact}</p>
                        {exploit.bypassTechnique && (
                          <p><strong>Bypass-Technik:</strong> {exploit.bypassTechnique}</p>
                        )}
                      </AlertDescription>
                    </Alert>
                  )}
                </CardContent>
              </Card>
            )
          })}
        </div>

        {!submitted ? (
          <div className="flex gap-4">
            <Button
              onClick={handleSubmit}
              disabled={!allAnswered}
              className="flex-1 bg-gradient-to-r from-[rgb(var(--cyber-cyan))] to-[rgb(var(--cyber-magenta))] text-black font-semibold hover:opacity-90"
            >
              AUSWERTUNG ANZEIGEN
            </Button>
            <Button
              onClick={handleReset}
              className="bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Zurücksetzen
            </Button>
          </div>
        ) : (
          <div className="space-y-6">
            <Card className="bg-gradient-to-br from-[rgb(var(--cyber-cyan))]/10 to-[rgb(var(--cyber-magenta))]/10 border-[rgb(var(--cyber-cyan))]/30">
              <CardHeader>
                <CardTitle className="text-3xl text-[rgb(var(--cyber-cyan))]">Ergebnis: {score}%</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-readable-dim text-lg">
                  Du hast {Math.round((score / 100) * domXssExploits.length)} von {domXssExploits.length} Exploits korrekt identifiziert.
                </p>
              </CardContent>
            </Card>

            <Card className="bg-[rgb(var(--cyber-surface))] border-amber-500/30">
              <CardHeader>
                <CardTitle className="text-amber-500">Remediation - Sichere Coding-Praktiken</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2 text-readable-dim">
                <p>• <strong>NIEMALS</strong> .innerHTML mit unsanitized user input verwenden</p>
                <p>• Verwende .textContent oder .innerText für reinen Text</p>
                <p>• Implementiere Content Security Policy (CSP) Headers</p>
                <p>• Nutze DOMPurify für HTML sanitization</p>
                <p>• Validiere und encode alle URL-Parameter</p>
                <p>• Verwende framework-eigene security features (React, Angular, Vue)</p>
              </CardContent>
            </Card>

            <Button
              onClick={handleReset}
              className="w-full bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Erneut versuchen
            </Button>
          </div>
        )}
      </div>
    </div>
  )
}
