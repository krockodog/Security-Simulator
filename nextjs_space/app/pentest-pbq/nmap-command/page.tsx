'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Checkbox } from '@/components/ui/checkbox'
import { ArrowLeft, AlertCircle, CheckCircle2, Terminal, XCircle } from 'lucide-react'
import { nmapScenario, nmapCommandOptions, attackVectors, correctNmapCommand } from '@/lib/pt003-data'

export default function NmapCommandPBQ() {
  const [selectedFlags, setSelectedFlags] = useState<string[]>([])
  const [selectedVectors, setSelectedVectors] = useState<string[]>([])
  const [submitted, setSubmitted] = useState(false)
  const [commandScore, setCommandScore] = useState(0)
  const [vectorsScore, setVectorsScore] = useState(0)
  
  // Correct attack vectors based on open ports
  const correctVectorIds = ['av1', 'av2', 'av3', 'av6']

  const handleFlagToggle = (flagId: string) => {
    setSelectedFlags(prev => 
      prev.includes(flagId)
        ? prev.filter(id => id !== flagId)
        : [...prev, flagId]
    )
  }

  const handleVectorToggle = (vectorId: string) => {
    setSelectedVectors(prev =>
      prev.includes(vectorId)
        ? prev.filter(id => id !== vectorId)
        : [...prev, vectorId]
    )
  }

  const handleSubmit = () => {
    // Check command correctness
    const commandCorrect = correctNmapCommand.every(id => selectedFlags.includes(id)) &&
                          selectedFlags.length === correctNmapCommand.length
    setCommandScore(commandCorrect ? 100 : 0)

    // Check vectors correctness
    const vectorsCorrect = correctVectorIds.length > 0 
      ? (selectedVectors.filter(id => correctVectorIds.includes(id)).length / correctVectorIds.length) * 100
      : 0
    setVectorsScore(Math.round(vectorsCorrect))

    setSubmitted(true)
  }

  const handleReset = () => {
    setSelectedFlags([])
    setSelectedVectors([])
    setSubmitted(false)
    setCommandScore(0)
    setVectorsScore(0)
  }

  const builtCommand = selectedFlags
    .map(id => nmapCommandOptions.find(opt => opt.id === id)?.flag)
    .filter(Boolean)
    .join(' ')

  const correctCommand = correctNmapCommand
    .map(id => nmapCommandOptions.find(opt => opt.id === id)?.flag)
    .join(' ')

  const totalScore = Math.round((commandScore + vectorsScore) / 2)

  return (
    <div className="min-h-screen cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 2: Nmap Command Construction</h1>
          <p className="text-readable-dim text-lg">{nmapScenario.title}</p>
        </div>

        {/* Scenario */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Szenario</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-readable-dim whitespace-pre-line">{nmapScenario.scenario}</p>
            <Alert className="mt-4 border border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface-elevated))]">
              <Terminal className="h-4 w-4 text-[rgb(var(--cyber-cyan))]" />
              <AlertTitle className="text-readable">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {nmapScenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        {/* Scan Output */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Nmap Scan Output</CardTitle>
          </CardHeader>
          <CardContent>
            <pre className="bg-[rgb(var(--cyber-surface-elevated))] p-4 rounded text-sm text-[rgb(var(--cyber-cyan))] overflow-x-auto border border-[rgb(var(--cyber-border))]">
              {nmapScenario.scanOutput}
            </pre>
          </CardContent>
        </Card>

        {/* Part 1: Command Construction */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Teil 1: Konstruiere den Nmap-Befehl</CardTitle>
            <CardDescription className="text-readable-dim">
              Wähle die richtigen Flags aus, um den Befehl zu erstellen, der diesen Output erzeugt hat
            </CardDescription>
          </CardHeader>
          <CardContent>
            {/* Built Command Display */}
            <div className="mb-6">
              <p className="text-sm font-medium text-readable mb-2">Dein Befehl:</p>
              <div className={`bg-[rgb(var(--cyber-surface-elevated))] p-4 rounded border ${
                submitted
                  ? commandScore === 100
                    ? 'border-[rgb(var(--cyber-success))]'
                    : 'border-[rgb(var(--cyber-error))]'
                  : 'border-[rgb(var(--cyber-border))]'
              }`}>
                <code className="text-[rgb(var(--cyber-cyan))] text-sm">
                  {builtCommand || 'Wähle Flags aus...'}
                </code>
              </div>
              {submitted && commandScore === 0 && (
                <div className="mt-2">
                  <p className="text-sm font-medium text-readable mb-1">Richtiger Befehl:</p>
                  <div className="bg-[rgb(var(--cyber-surface-elevated))] p-3 rounded border border-[rgb(var(--cyber-success))]">
                    <code className="text-[rgb(var(--cyber-success))] text-sm">
                      {correctCommand}
                    </code>
                  </div>
                </div>
              )}
            </div>

            {/* Flag Selection */}
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
              {nmapCommandOptions.map(option => {
                const isSelected = selectedFlags.includes(option.id)
                const isCorrect = submitted && correctNmapCommand.includes(option.id)
                const isIncorrect = submitted && isSelected && !correctNmapCommand.includes(option.id)

                return (
                  <div
                    key={option.id}
                    onClick={() => !submitted && handleFlagToggle(option.id)}
                    className={`p-3 rounded border cursor-pointer transition-all ${
                      submitted
                        ? isCorrect
                          ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                          : isIncorrect
                          ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
                          : 'border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))]'
                        : isSelected
                        ? 'border-[rgb(var(--cyber-cyan))] bg-[rgba(0,220,220,0.05)]'
                        : 'border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))] hover:border-[rgb(var(--cyber-cyan))]'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <Checkbox
                        checked={isSelected}
                        disabled={submitted}
                        className="mt-0.5"
                      />
                      <div className="flex-1">
                        <code className="text-sm font-mono text-[rgb(var(--cyber-cyan))]">{option.flag}</code>
                        <p className="text-xs text-readable-dim mt-1">{option.description}</p>
                      </div>
                      {submitted && (
                        isCorrect ? (
                          <CheckCircle2 className="h-4 w-4 text-[rgb(var(--cyber-success))] flex-shrink-0" />
                        ) : isIncorrect ? (
                          <XCircle className="h-4 w-4 text-[rgb(var(--cyber-error))] flex-shrink-0" />
                        ) : null
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        {/* Part 2: Attack Vectors */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Teil 2: Identifiziere Attack Vectors</CardTitle>
            <CardDescription className="text-readable-dim">
              Basierend auf dem Scan-Output, wähle alle zutreffenden Attack Vectors aus
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {attackVectors.map(vector => {
                const isSelected = selectedVectors.includes(vector.id)
                const shouldBeSelected = correctVectorIds.includes(vector.id)
                const isCorrect = submitted && isSelected && shouldBeSelected
                const isIncorrect = submitted && isSelected && !shouldBeSelected
                const isMissed = submitted && !isSelected && shouldBeSelected

                return (
                  <div
                    key={vector.id}
                    onClick={() => !submitted && handleVectorToggle(vector.id)}
                    className={`p-4 rounded border cursor-pointer transition-all ${
                      submitted
                        ? isCorrect
                          ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                          : isIncorrect
                          ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
                          : isMissed
                          ? 'border-[rgb(var(--cyber-yellow))] bg-[rgba(220,220,0,0.05)]'
                          : 'border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))]'
                        : isSelected
                        ? 'border-[rgb(var(--cyber-cyan))] bg-[rgba(0,220,220,0.05)]'
                        : 'border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))] hover:border-[rgb(var(--cyber-cyan))]'
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <Checkbox
                        checked={isSelected}
                        disabled={submitted}
                        className="mt-1"
                      />
                      <div className="flex-1">
                        <p className="font-medium text-readable">{vector.name}</p>
                        <p className="text-sm text-readable-dim mt-1">{vector.description}</p>
                        {submitted && shouldBeSelected && (
                          <p className="text-sm text-[rgb(var(--cyber-success))] mt-2">
                            Port(s): {vector.ports.join(', ')} - Dieser Attack Vector ist basierend auf dem Scan-Output relevant.
                          </p>
                        )}
                      </div>
                      {submitted && (
                        isCorrect ? (
                          <CheckCircle2 className="h-5 w-5 text-[rgb(var(--cyber-success))] flex-shrink-0" />
                        ) : isIncorrect ? (
                          <XCircle className="h-5 w-5 text-[rgb(var(--cyber-error))] flex-shrink-0" />
                        ) : isMissed ? (
                          <AlertCircle className="h-5 w-5 text-[rgb(var(--cyber-yellow))] flex-shrink-0" />
                        ) : null
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex gap-4">
          {!submitted ? (
            <Button
              onClick={handleSubmit}
              disabled={selectedFlags.length === 0 || selectedVectors.length === 0}
              className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Auswertung anzeigen
            </Button>
          ) : (
            <Button
              onClick={handleReset}
              className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Zurücksetzen
            </Button>
          )}
        </div>

        {/* Results */}
        {submitted && (
          <Card className="cyber-card mt-8">
            <CardHeader>
              <CardTitle className="text-2xl text-readable">Ergebnis</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <p className="text-lg text-readable">
                    Gesamt-Score: <span className={`font-bold ${
                      totalScore >= 80 ? 'text-[rgb(var(--cyber-success))]' :
                      totalScore >= 60 ? 'text-[rgb(var(--cyber-yellow))]' :
                      'text-[rgb(var(--cyber-error))]'
                    }`}>{totalScore}%</span>
                  </p>
                  <div className="mt-2 space-y-1 text-sm text-readable-dim">
                    <p>Kommando-Konstruktion: {commandScore}%</p>
                    <p>Attack Vectors: {vectorsScore}%</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}