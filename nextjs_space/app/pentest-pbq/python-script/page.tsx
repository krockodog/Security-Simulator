'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { ArrowLeft, CheckCircle2, XCircle } from 'lucide-react'
import { pythonScriptScenario, pythonCodeSegments } from '@/lib/pt003-data'

export default function PythonScriptPBQ() {
  const [selected, setSelected] = useState<{[key: string]: string}>({})
  const [submitted, setSubmitted] = useState(false)
  const positions = ['shebang', 'imports', 'ports', 'loop', 'call']
  const correctAnswers = {
    shebang: '#!/usr/bin/python',
    imports: 'import socket\nimport sys',
    ports: 'ports = [21, 22]',
    loop: 'for port in ports:',
    call: 'scan(sys.argv[1], ports)'
  }

  const handleSubmit = () => setSubmitted(true)
  const calculateScore = () => {
    let correct = 0
    Object.keys(correctAnswers).forEach(pos => {
      if (selected[pos] === correctAnswers[pos as keyof typeof correctAnswers]) correct++
    })
    return Math.round((correct / positions.length) * 100)
  }

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4">
      <div className="max-w-5xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <h1 className="text-3xl font-bold text-readable mb-2">PBQ 4: Python Port Scanner Script</h1>
        <p className="text-readable-dim text-lg mb-8">{pythonScriptScenario.title}</p>

        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Szenario</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-readable-dim whitespace-pre-line">{pythonScriptScenario.scenario}</p>
            <Alert className="mt-4 border border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface-elevated))]">
              <AlertDescription className="text-readable-dim">{pythonScriptScenario.instructions}</AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        <div className="grid lg:grid-cols-2 gap-8 mb-8">
          <div>
            <h3 className="text-lg font-semibold text-readable mb-4">Code-Segmente</h3>
            <div className="space-y-2">
              {pythonCodeSegments.map(seg => (
                <div key={seg.id} draggable className="p-3 bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-border))] rounded cursor-move hover:border-[rgb(var(--cyber-cyan))] transition">
                  <code className="text-sm text-[rgb(var(--cyber-cyan))]">{seg.code}</code>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h3 className="text-lg font-semibold text-readable mb-4">Script-Struktur</h3>
            {positions.map(pos => (
              <div key={pos} className={`mb-4 p-4 border rounded ${ submitted ? selected[pos] === correctAnswers[pos as keyof typeof correctAnswers] ? 'border-[rgb(var(--cyber-success))]' : 'border-[rgb(var(--cyber-error))]' : 'border-[rgb(var(--cyber-border))]'}`}>
                <p className="text-sm text-readable-dim mb-2">{pos}:</p>
                <select value={selected[pos] || ''} onChange={(e) => setSelected({...selected, [pos]: e.target.value})} disabled={submitted} className="w-full bg-[rgb(var(--cyber-surface))] text-readable p-2 rounded border border-[rgb(var(--cyber-border))]">
                  <option value="">Wähle Code...</option>
                  {pythonCodeSegments.filter(s => s.position === pos).map(s => (
                    <option key={s.id} value={s.code}>{s.code}</option>
                  ))}
                </select>
                {submitted && (
                  <div className="mt-2 flex items-center gap-2">
                    {selected[pos] === correctAnswers[pos as keyof typeof correctAnswers] ? (
                      <><CheckCircle2 className="h-4 w-4 text-[rgb(var(--cyber-success))]" /><span className="text-sm text-[rgb(var(--cyber-success))]">Richtig</span></>
                    ) : (
                      <><XCircle className="h-4 w-4 text-[rgb(var(--cyber-error))]" /><span className="text-sm text-[rgb(var(--cyber-error))]">Falsch</span></>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>

        <div className="flex gap-4">
          {!submitted ? (
            <Button onClick={handleSubmit} disabled={Object.keys(selected).length < positions.length} className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable" size="lg">
              Auswertung anzeigen
            </Button>
          ) : (
            <Button onClick={() => { setSelected({}); setSubmitted(false); }} className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable" size="lg">
              Zurücksetzen
            </Button>
          )}
        </div>

        {submitted && (
          <Card className="cyber-card mt-8">
            <CardHeader>
              <CardTitle className="text-2xl text-readable">Ergebnis</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-lg text-readable">
                Score: <span className={`font-bold ${calculateScore() >= 80 ? 'text-[rgb(var(--cyber-success))]' : calculateScore() >= 60 ? 'text-[rgb(var(--cyber-yellow))]' : 'text-[rgb(var(--cyber-error))]'}`}>{calculateScore()}%</span>
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
