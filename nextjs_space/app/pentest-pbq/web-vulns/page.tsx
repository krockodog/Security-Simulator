'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { ArrowLeft, AlertCircle, CheckCircle2, XCircle, Terminal } from 'lucide-react'
import { webVulnerabilities } from '@/lib/pt003-data'

export default function WebVulnsPBQ() {
  const [userAnswers, setUserAnswers] = useState<{[key: string]: string}>({})
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const vulnTypes = Array.from(new Set(webVulnerabilities.map(v => v.vulnerabilityType)))

  const handleAnswerChange = (vulnId: string, answer: string) => {
    setUserAnswers(prev => ({ ...prev, [vulnId]: answer }))
  }

  const handleSubmit = () => {
    let correct = 0
    webVulnerabilities.forEach(vuln => {
      if (userAnswers[vuln.id] === vuln.vulnerabilityType) {
        correct++
      }
    })
    setScore(Math.round((correct / webVulnerabilities.length) * 100))
    setSubmitted(true)
  }

  const handleReset = () => {
    setUserAnswers({})
    setSubmitted(false)
    setScore(0)
  }

  return (
    <div className="min-h-screen cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 1: Web Vulnerability Identification</h1>
          <p className="text-readable-dim text-lg">Identifiziere den richtigen Vulnerability-Typ für jeden HTTP-Payload</p>
        </div>

        <Alert className="mb-8 border border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface))]">
          <Terminal className="h-4 w-4 text-[rgb(var(--cyber-cyan))]" />
          <AlertTitle className="text-readable">Anleitung</AlertTitle>
          <AlertDescription className="text-readable-dim">
            Analysiere die HTTP-Payloads und wähle den passenden Vulnerability-Typ aus dem Dropdown-Menü aus.
          </AlertDescription>
        </Alert>

        <div className="space-y-4 mb-8">
          {webVulnerabilities.map(vuln => {
            const isCorrect = submitted && userAnswers[vuln.id] === vuln.vulnerabilityType
            const isIncorrect = submitted && userAnswers[vuln.id] && userAnswers[vuln.id] !== vuln.vulnerabilityType
            
            return (
              <Card
                key={vuln.id}
                className={`cyber-card transition-all ${
                  submitted
                    ? isCorrect
                      ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                      : isIncorrect
                      ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
                      : 'border-[rgb(var(--cyber-yellow))] bg-[rgba(220,220,0,0.05)]'
                    : userAnswers[vuln.id]
                    ? 'border-[rgb(var(--cyber-cyan))]'
                    : ''
                }`}
              >
                <CardContent className="p-6">
                  <div className="space-y-4">
                    <div>
                      <p className="text-sm text-readable-dim mb-2">Payload:</p>
                      <code className="text-sm text-[rgb(var(--cyber-cyan))] bg-[rgb(var(--cyber-surface-elevated))] px-3 py-2 rounded block break-all">
                        {vuln.payload}
                      </code>
                    </div>

                    <div>
                      <p className="text-sm text-readable-dim mb-2">Vulnerability-Typ:</p>
                      <Select
                        value={userAnswers[vuln.id]}
                        onValueChange={(value) => handleAnswerChange(vuln.id, value)}
                        disabled={submitted}
                      >
                        <SelectTrigger className="cyber-input">
                          <SelectValue placeholder="Wähle einen Typ..." />
                        </SelectTrigger>
                        <SelectContent className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-border))]">
                          {vulnTypes.map(type => (
                            <SelectItem key={type} value={type} className="text-readable hover:bg-[rgb(var(--cyber-surface-elevated))]">
                              {type}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    {submitted && (
                      <div className="flex items-start gap-3 pt-2 border-t border-[rgb(var(--cyber-border))]">
                        {isCorrect ? (
                          <CheckCircle2 className="h-5 w-5 text-[rgb(var(--cyber-success))] flex-shrink-0 mt-0.5" />
                        ) : (
                          <XCircle className="h-5 w-5 text-[rgb(var(--cyber-error))] flex-shrink-0 mt-0.5" />
                        )}
                        <div className="flex-1 text-sm">
                          <p className="text-readable">
                            <span className="font-medium">Richtig:</span> {vuln.vulnerabilityType}
                          </p>
                          <p className="text-readable-dim mt-1">{vuln.explanation}</p>
                          <p className="text-[rgb(var(--cyber-cyan))] mt-2">
                            <span className="font-medium">Remediation:</span> {vuln.remediation}
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>

        <div className="flex gap-4">
          {!submitted ? (
            <Button
              onClick={handleSubmit}
              disabled={Object.keys(userAnswers).length !== webVulnerabilities.length}
              className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Auswertung anzeigen
            </Button>
          ) : (
            <Button
              onClick={handleReset}
              className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Zurücksetzen
            </Button>
          )}
        </div>

        {submitted && (
          <Card className="cyber-card mt-8">
            <CardHeader>
              <CardTitle className="text-2xl text-readable">Ergebnis</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-lg text-readable">
                Score: <span className={`font-bold ${
                  score >= 80 ? 'text-[rgb(var(--cyber-success))]' :
                  score >= 60 ? 'text-[rgb(var(--cyber-yellow))]' :
                  'text-[rgb(var(--cyber-error))]'
                }`}>{score}%</span>
              </p>
              <p className="text-readable-dim mt-2">
                {score >= 80 ? 'Ausgezeichnet! Du hast die meisten Vulnerabilities korrekt identifiziert.' :
                 score >= 60 ? 'Gut gemacht! Mit etwas mehr Übung wirst du besser.' :
                 'Weiter üben! Analysiere die Payloads genauer und lerne die verschiedenen Vulnerability-Typen.'}
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
