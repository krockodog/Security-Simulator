'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { ArrowLeft, AlertCircle, CheckCircle2, XCircle, Cloud } from 'lucide-react'
import { cloudS3Scenario, s3BucketVulnerabilities, s3RemediationSteps } from '@/lib/pt003-data'

export default function CloudS3PBQ() {
  const [userAnswers, setUserAnswers] = useState<{[key: string]: string}>({})
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const vulnerabilityTypes = Array.from(new Set(s3BucketVulnerabilities.map(v => v.vulnerability)))

  const handleAnswerChange = (bucketId: string, answer: string) => {
    setUserAnswers(prev => ({ ...prev, [bucketId]: answer }))
  }

  const handleSubmit = () => {
    let correct = 0
    s3BucketVulnerabilities.forEach(bucket => {
      if (userAnswers[bucket.id] === bucket.vulnerability) {
        correct++
      }
    })
    setScore(Math.round((correct / s3BucketVulnerabilities.length) * 100))
    setSubmitted(true)
  }

  const handleReset = () => {
    setUserAnswers({})
    setSubmitted(false)
    setScore(0)
  }

  const allAnswered = s3BucketVulnerabilities.every(bucket => userAnswers[bucket.id])

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zur체ck zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 9: {cloudS3Scenario.title}</h1>
          <p className="text-readable-dim text-lg">AWS S3 Bucket Security Assessment</p>
        </div>

        <Card className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/20 mb-6">
          <CardHeader>
            <CardTitle className="text-[rgb(var(--cyber-cyan))] flex items-center gap-2">
              <Cloud className="h-5 w-5" />
              Szenario
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <p className="text-readable-dim whitespace-pre-line">{cloudS3Scenario.scenario}</p>
            <Alert className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
              <Cloud className="h-4 w-4" />
              <AlertTitle className="text-[rgb(var(--cyber-cyan))]">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {cloudS3Scenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        <div className="space-y-6 mb-8">
          {s3BucketVulnerabilities.map((bucket, idx) => {
            const isCorrect = submitted && userAnswers[bucket.id] === bucket.vulnerability
            const isWrong = submitted && userAnswers[bucket.id] && userAnswers[bucket.id] !== bucket.vulnerability

            return (
              <Card 
                key={bucket.id}
                className={`bg-[rgb(var(--cyber-surface))] transition-all ${
                  isCorrect ? 'border-green-500/50 bg-green-500/5' : 
                  isWrong ? 'border-red-500/50 bg-red-500/5' : 
                  'border-[rgb(var(--cyber-cyan))]/20'
                }`}
              >
                <CardHeader>
                  <CardTitle className="text-readable text-lg flex items-center gap-2">
                    {isCorrect && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {isWrong && <XCircle className="h-5 w-5 text-red-500" />}
                    S3 Bucket {idx + 1}: {bucket.bucketName}
                  </CardTitle>
                  <CardDescription className="text-readable-dim">
                    <code className="text-[rgb(var(--cyber-cyan))] text-sm">{bucket.awsCliCommand}</code>
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Select
                    value={userAnswers[bucket.id] || ''}
                    onValueChange={(value) => handleAnswerChange(bucket.id, value)}
                    disabled={submitted}
                  >
                    <SelectTrigger className="w-full bg-[rgb(var(--cyber-surface-light))] border-[rgb(var(--cyber-cyan))]/30 text-readable">
                      <SelectValue placeholder="W채hle Vulnerability Type..." />
                    </SelectTrigger>
                    <SelectContent className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
                      {vulnerabilityTypes.map((vulnType) => (
                        <SelectItem key={vulnType} value={vulnType} className="text-readable">
                          {vulnType}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>

                  {submitted && (
                    <Alert className={`${
                      isCorrect ? 'bg-green-500/10 border-green-500/50' : 'bg-amber-500/10 border-amber-500/50'
                    }`}>
                      <AlertCircle className={`h-4 w-4 ${isCorrect ? 'text-green-500' : 'text-amber-500'}`} />
                      <AlertTitle className={isCorrect ? 'text-green-500' : 'text-amber-500'}>
                        {isCorrect ? 'Richtig!' : 'Erkl채rung'}
                      </AlertTitle>
                      <AlertDescription className="text-readable-dim space-y-2">
                        <p><strong>Richtige Antwort:</strong> {bucket.vulnerability}</p>
                        <p><strong>Impact:</strong> {bucket.impact}</p>
                        <p><strong>Remediation:</strong> {bucket.remediation}</p>
                      </AlertDescription>
                    </Alert>
                  )}
                </CardContent>
              </Card>
            )
          })}
        </div>

        {!submitted ? (
          <div className="flex gap-4">
            <Button
              onClick={handleSubmit}
              disabled={!allAnswered}
              className="flex-1 bg-gradient-to-r from-[rgb(var(--cyber-cyan))] to-[rgb(var(--cyber-magenta))] text-black font-semibold hover:opacity-90"
            >
              AUSWERTUNG ANZEIGEN
            </Button>
            <Button
              onClick={handleReset}
              className="bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Zur체cksetzen
            </Button>
          </div>
        ) : (
          <div className="space-y-6">
            <Card className="bg-gradient-to-br from-[rgb(var(--cyber-cyan))]/10 to-[rgb(var(--cyber-magenta))]/10 border-[rgb(var(--cyber-cyan))]/30">
              <CardHeader>
                <CardTitle className="text-3xl text-[rgb(var(--cyber-cyan))]">Ergebnis: {score}%</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-readable-dim text-lg">
                  Du hast {Math.round((score / 100) * s3BucketVulnerabilities.length)} von {s3BucketVulnerabilities.length} S3 Buckets korrekt analysiert.
                </p>
              </CardContent>
            </Card>

            <Card className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
              <CardHeader>
                <CardTitle className="text-[rgb(var(--cyber-cyan))]">AWS S3 Security Best Practices</CardTitle>
              </CardHeader>
              <CardContent>
                <ul className="list-disc list-inside space-y-2 text-readable-dim">
                  {s3RemediationSteps.map((step, idx) => (
                    <li key={idx}>{step}</li>
                  ))}
                </ul>
              </CardContent>
            </Card>

            <Button
              onClick={handleReset}
              className="w-full bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Erneut versuchen
            </Button>
          </div>
        )}
      </div>
    </div>
  )
}
