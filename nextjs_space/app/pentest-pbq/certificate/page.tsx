'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { ArrowLeft, CheckCircle2, XCircle, Terminal, Eye } from 'lucide-react'
import { certificateScenario, certificateVulnerabilities } from '@/lib/pt003-data'

export default function CertificatePBQ() {
  const [selectedVuln, setSelectedVuln] = useState<string>('')
  const [selectedSteps, setSelectedSteps] = useState<string[]>([])
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const correctVuln = certificateVulnerabilities.find(v => v.severity === 'Critical')

  const handleStepToggle = (step: string) => {
    setSelectedSteps(prev =>
      prev.includes(step)
        ? prev.filter(s => s !== step)
        : [...prev, step]
    )
  }

  const handleSubmit = () => {
    let points = 0
    
    // Check vulnerability identification (50 points)
    if (selectedVuln === correctVuln?.id) {
      points += 50
    }

    // Check remediation steps (50 points)
    if (correctVuln) {
      const correctSteps = correctVuln.remediationSteps
      const allCorrect = correctSteps.every(step => selectedSteps.includes(step))
      const noExtras = selectedSteps.every(step => correctSteps.includes(step))
      if (allCorrect && noExtras) {
        points += 50
      } else if (allCorrect) {
        points += 25
      }
    }

    setScore(points)
    setSubmitted(true)
  }

  const handleReset = () => {
    setSelectedVuln('')
    setSelectedSteps([])
    setSubmitted(false)
    setScore(0)
  }

  const allRemediationSteps = Array.from(
    new Set(certificateVulnerabilities.flatMap(v => v.remediationSteps))
  )

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 3: Web Application Security Assessment</h1>
          <p className="text-readable-dim text-lg">{certificateScenario.title}</p>
        </div>

        {/* Scenario */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Szenario</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-readable-dim whitespace-pre-line">{certificateScenario.scenario}</p>
            <Alert className="mt-4 border border-[rgb(var(--cyber-border))] bg-[rgb(var(--cyber-surface-elevated))]">
              <Terminal className="h-4 w-4 text-[rgb(var(--cyber-cyan))]" />
              <AlertTitle className="text-readable">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {certificateScenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        {/* Investigation Tabs */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable flex items-center gap-2">
              <Eye className="h-5 w-5" />
              Untersuchung
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Tabs defaultValue="certificate" className="w-full">
              <TabsList className="grid w-full grid-cols-3 bg-[rgb(var(--cyber-surface-elevated))]">
                <TabsTrigger value="certificate" className="data-[state=active]:bg-[rgb(var(--cyber-cyan))] data-[state=active]:text-black">
                  View Certificate
                </TabsTrigger>
                <TabsTrigger value="source" className="data-[state=active]:bg-[rgb(var(--cyber-cyan))] data-[state=active]:text-black">
                  View Source
                </TabsTrigger>
                <TabsTrigger value="cookies" className="data-[state=active]:bg-[rgb(var(--cyber-cyan))] data-[state=active]:text-black">
                  View Cookies
                </TabsTrigger>
              </TabsList>

              <TabsContent value="certificate" className="mt-4">
                <div className="bg-[rgb(var(--cyber-surface-elevated))] p-4 rounded border border-[rgb(var(--cyber-border))]">
                  <h3 className="text-lg font-semibold text-readable mb-3">SSL/TLS Certificate Information</h3>
                  <div className="space-y-2 text-sm text-readable-dim">
                    <p><span className="text-readable">Subject:</span> CN=comptia.org</p>
                    <p><span className="text-readable">Issuer:</span> CN=DigiCert SHA2 Secure Server CA</p>
                    <p><span className="text-readable">Valid From:</span> 2023-01-15 00:00:00 UTC</p>
                    <p className="text-[rgb(var(--cyber-error))]"><span className="text-readable">Valid To:</span> 2024-01-14 23:59:59 UTC (EXPIRED)</p>
                    <p><span className="text-readable">Serial Number:</span> 0F1A2B3C4D5E6F7A8B9C0D1E2F3A4B5C</p>
                    <p><span className="text-readable">Signature Algorithm:</span> SHA256-RSA</p>
                  </div>
                </div>
              </TabsContent>

              <TabsContent value="source" className="mt-4">
                <div className="bg-[rgb(var(--cyber-surface-elevated))] p-4 rounded border border-[rgb(var(--cyber-border))]">
                  <h3 className="text-lg font-semibold text-readable mb-3">Page Source Code</h3>
                  <pre className="text-sm text-[rgb(var(--cyber-cyan))] overflow-x-auto">{`<html>
<head>
  <title>CompTIA Login</title>
</head>
<body>
  <form action="/auth" method="post">
    <input type="text" name="username" />
    <input type="password" name="password" />
    <!-- Default credentials -->
    <!-- admin:P@ssw0rd123 -->
    <button type="submit">Login</button>
  </form>
</body>
</html>`}</pre>
                </div>
              </TabsContent>

              <TabsContent value="cookies" className="mt-4">
                <div className="bg-[rgb(var(--cyber-surface-elevated))] p-4 rounded border border-[rgb(var(--cyber-border))]">
                  <h3 className="text-lg font-semibold text-readable mb-3">HTTP Cookies</h3>
                  <div className="space-y-3 text-sm">
                    <div className="border-l-2 border-[rgb(var(--cyber-border))] pl-3">
                      <p className="text-readable font-medium">sessionID</p>
                      <p className="text-readable-dim">Value: a1b2c3d4e5f6g7h8</p>
                      <p className="text-readable-dim">Domain: comptia.org</p>
                      <p className="text-readable-dim">Secure: No</p>
                      <p className="text-readable-dim">HttpOnly: No</p>
                    </div>
                    <div className="border-l-2 border-[rgb(var(--cyber-border))] pl-3">
                      <p className="text-readable font-medium">user_prefs</p>
                      <p className="text-readable-dim">Value: theme=dark;lang=en</p>
                      <p className="text-readable-dim">Domain: comptia.org</p>
                      <p className="text-readable-dim">Secure: Yes</p>
                      <p className="text-readable-dim">HttpOnly: Yes</p>
                    </div>
                  </div>
                </div>
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>

        {/* Vulnerability Selection */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Schritt 1: Identifiziere die kritischste Schwachstelle</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {certificateVulnerabilities.map(vuln => {
                const isSelected = selectedVuln === vuln.id
                const isCorrect = submitted && vuln.severity === 'Critical'
                const isIncorrect = submitted && isSelected && vuln.severity !== 'Critical'

                return (
                  <div
                    key={vuln.id}
                    onClick={() => !submitted && setSelectedVuln(vuln.id)}
                    className={`p-4 rounded border cursor-pointer transition-all ${
                      submitted
                        ? isCorrect
                          ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                          : isIncorrect
                          ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
                          : 'border-[rgb(var(--cyber-border))]'
                        : isSelected
                        ? 'border-[rgb(var(--cyber-cyan))] bg-[rgba(0,220,220,0.05)]'
                        : 'border-[rgb(var(--cyber-border))] hover:border-[rgb(var(--cyber-cyan))]'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            vuln.severity === 'Critical' ? 'bg-red-900/30 text-red-400' :
                            vuln.severity === 'High' ? 'bg-orange-900/30 text-orange-400' :
                            vuln.severity === 'Medium' ? 'bg-yellow-900/30 text-yellow-400' :
                            'bg-green-900/30 text-green-400'
                          }`}>
                            {vuln.severity}
                          </span>
                          <span className="text-xs text-readable-dim">{vuln.area}</span>
                        </div>
                        <p className="font-medium text-readable">{vuln.issue}</p>
                        {submitted && (
                          <p className="text-sm text-readable-dim mt-2">{vuln.explanation}</p>
                        )}
                      </div>
                      {submitted && (
                        isCorrect ? (
                          <CheckCircle2 className="h-5 w-5 text-[rgb(var(--cyber-success))] flex-shrink-0" />
                        ) : isIncorrect ? (
                          <XCircle className="h-5 w-5 text-[rgb(var(--cyber-error))] flex-shrink-0" />
                        ) : null
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        {/* Remediation Steps */}
        <Card className="cyber-card mb-8">
          <CardHeader>
            <CardTitle className="text-xl text-readable">Schritt 2: Wähle die korrekten Remediation Steps (in Reihenfolge)</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {allRemediationSteps.map((step, idx) => {
                const isSelected = selectedSteps.includes(step)
                const isCorrect = submitted && correctVuln?.remediationSteps.includes(step)
                const isIncorrect = submitted && isSelected && !correctVuln?.remediationSteps.includes(step)

                return (
                  <div
                    key={idx}
                    onClick={() => !submitted && handleStepToggle(step)}
                    className={`p-3 rounded border cursor-pointer transition-all text-sm ${
                      submitted
                        ? isCorrect
                          ? 'border-[rgb(var(--cyber-success))] bg-[rgba(0,220,140,0.05)]'
                          : isIncorrect
                          ? 'border-[rgb(var(--cyber-error))] bg-[rgba(220,40,90,0.05)]'
                          : 'border-[rgb(var(--cyber-border))]'
                        : isSelected
                        ? 'border-[rgb(var(--cyber-cyan))] bg-[rgba(0,220,220,0.05)]'
                        : 'border-[rgb(var(--cyber-border))] hover:border-[rgb(var(--cyber-cyan))]'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <span className="text-readable">{step}</span>
                      {isSelected && !submitted && (
                        <span className="text-xs text-[rgb(var(--cyber-cyan))]">
                          {selectedSteps.indexOf(step) + 1}
                        </span>
                      )}
                      {submitted && (
                        isCorrect ? (
                          <CheckCircle2 className="h-4 w-4 text-[rgb(var(--cyber-success))]" />
                        ) : isIncorrect ? (
                          <XCircle className="h-4 w-4 text-[rgb(var(--cyber-error))]" />
                        ) : null
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex gap-4">
          {!submitted ? (
            <Button
              onClick={handleSubmit}
              disabled={!selectedVuln || selectedSteps.length === 0}
              className="cyber-button neon-border-magenta bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Auswertung anzeigen
            </Button>
          ) : (
            <Button
              onClick={handleReset}
              className="cyber-button neon-border-cyan bg-[rgb(var(--cyber-surface-elevated))] text-readable"
              size="lg"
            >
              Zurücksetzen
            </Button>
          )}
        </div>

        {/* Results */}
        {submitted && (
          <Card className="cyber-card mt-8">
            <CardHeader>
              <CardTitle className="text-2xl text-readable">Ergebnis</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-lg text-readable">
                Score: <span className={`font-bold ${
                  score >= 80 ? 'text-[rgb(var(--cyber-success))]' :
                  score >= 60 ? 'text-[rgb(var(--cyber-yellow))]' :
                  'text-[rgb(var(--cyber-error))]'
                }`}>{score} Punkte</span>
              </p>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
