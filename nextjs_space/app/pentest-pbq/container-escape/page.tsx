'use client'

import { useState } from 'react'
import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { ArrowLeft, AlertCircle, CheckCircle2, XCircle, Terminal, Shield } from 'lucide-react'
import { containerEscapeScenario, containerEscapePhases, containerEscapeRemediation } from '@/lib/pt003-data'

export default function ContainerEscapePBQ() {
  const [userAnswers, setUserAnswers] = useState<{[key: string]: string}>({})
  const [submitted, setSubmitted] = useState(false)
  const [score, setScore] = useState(0)

  const handleAnswerChange = (phaseId: string, answer: string) => {
    setUserAnswers(prev => ({ ...prev, [phaseId]: answer }))
  }

  const handleSubmit = () => {
    let correct = 0
    containerEscapePhases.forEach(phase => {
      if (userAnswers[phase.id] === phase.correctCommand) {
        correct++
      }
    })
    setScore(Math.round((correct / containerEscapePhases.length) * 100))
    setSubmitted(true)
  }

  const handleReset = () => {
    setUserAnswers({})
    setSubmitted(false)
    setScore(0)
  }

  const allAnswered = containerEscapePhases.every(phase => userAnswers[phase.id])

  // Generate command options from all phases
  const commandOptions = containerEscapePhases.map(p => p.correctCommand)

  return (
    <div className="min-h-screen bg-black cyber-grid py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        <Link href="/pentest-plus" className="inline-flex items-center text-[rgb(var(--cyber-magenta))] hover:text-[rgb(var(--cyber-cyan))] mb-6 transition-colors">
          <ArrowLeft className="h-4 w-4 mr-2" />
          Zurück zu PenTest+
        </Link>

        <div className="mb-8">
          <h1 className="text-3xl md:text-4xl font-bold text-readable mb-2">PBQ 5: {containerEscapeScenario.title}</h1>
          <p className="text-readable-dim text-lg">Docker Privilege Escalation & Host Compromise</p>
        </div>

        <Card className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/20 mb-6">
          <CardHeader>
            <CardTitle className="text-[rgb(var(--cyber-cyan))] flex items-center gap-2">
              <Shield className="h-5 w-5" />
              Szenario
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <p className="text-readable-dim whitespace-pre-line">{containerEscapeScenario.scenario}</p>
            <Alert className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
              <Terminal className="h-4 w-4" />
              <AlertTitle className="text-[rgb(var(--cyber-cyan))]">Anleitung</AlertTitle>
              <AlertDescription className="text-readable-dim">
                {containerEscapeScenario.instructions}
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>

        <div className="space-y-6 mb-8">
          {containerEscapePhases.map((phase, idx) => {
            const isCorrect = submitted && userAnswers[phase.id] === phase.correctCommand
            const isWrong = submitted && userAnswers[phase.id] && userAnswers[phase.id] !== phase.correctCommand

            return (
              <Card 
                key={phase.id}
                className={`bg-[rgb(var(--cyber-surface))] transition-all ${
                  isCorrect ? 'border-green-500/50 bg-green-500/5' : 
                  isWrong ? 'border-red-500/50 bg-red-500/5' : 
                  'border-[rgb(var(--cyber-cyan))]/20'
                }`}
              >
                <CardHeader>
                  <CardTitle className="text-readable text-lg flex items-center gap-2">
                    {isCorrect && <CheckCircle2 className="h-5 w-5 text-green-500" />}
                    {isWrong && <XCircle className="h-5 w-5 text-red-500" />}
                    Phase {idx + 1}: {phase.phase}
                  </CardTitle>
                  <CardDescription className="text-readable-dim">{phase.task}</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Select
                    value={userAnswers[phase.id] || ''}
                    onValueChange={(value) => handleAnswerChange(phase.id, value)}
                    disabled={submitted}
                  >
                    <SelectTrigger className="w-full bg-[rgb(var(--cyber-surface-light))] border-[rgb(var(--cyber-cyan))]/30 text-readable">
                      <SelectValue placeholder="Wähle Kommando..." />
                    </SelectTrigger>
                    <SelectContent className="bg-[rgb(var(--cyber-surface))] border-[rgb(var(--cyber-cyan))]/30">
                      {commandOptions.map((option) => (
                        <SelectItem key={option} value={option} className="text-readable">
                          <code className="text-sm text-[rgb(var(--cyber-cyan))]">{option}</code>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>

                  {submitted && (
                    <Alert className={`${
                      isCorrect ? 'bg-green-500/10 border-green-500/50' : 'bg-amber-500/10 border-amber-500/50'
                    }`}>
                      <AlertCircle className={`h-4 w-4 ${isCorrect ? 'text-green-500' : 'text-amber-500'}`} />
                      <AlertTitle className={isCorrect ? 'text-green-500' : 'text-amber-500'}>
                        {isCorrect ? 'Richtig!' : 'Erklärung'}
                      </AlertTitle>
                      <AlertDescription className="text-readable-dim space-y-2">
                        <p><strong>Richtige Antwort:</strong> <code className="text-[rgb(var(--cyber-cyan))]">{phase.correctCommand}</code></p>
                        <p><strong>Erklärung:</strong> {phase.explanation}</p>
                        <p><strong>Impact:</strong> {phase.impact}</p>
                      </AlertDescription>
                    </Alert>
                  )}
                </CardContent>
              </Card>
            )
          })}
        </div>

        {!submitted ? (
          <div className="flex gap-4">
            <Button
              onClick={handleSubmit}
              disabled={!allAnswered}
              className="flex-1 bg-gradient-to-r from-[rgb(var(--cyber-cyan))] to-[rgb(var(--cyber-magenta))] text-black font-semibold hover:opacity-90"
            >
              AUSWERTUNG ANZEIGEN
            </Button>
            <Button
              onClick={handleReset}
              className="bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Zurücksetzen
            </Button>
          </div>
        ) : (
          <div className="space-y-6">
            <Card className="bg-gradient-to-br from-[rgb(var(--cyber-cyan))]/10 to-[rgb(var(--cyber-magenta))]/10 border-[rgb(var(--cyber-cyan))]/30">
              <CardHeader>
                <CardTitle className="text-3xl text-[rgb(var(--cyber-cyan))]">Ergebnis: {score}%</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-readable-dim text-lg">
                  Du hast {Math.round((score / 100) * containerEscapePhases.length)} von {containerEscapePhases.length} Phasen korrekt gelöst.
                </p>
              </CardContent>
            </Card>

            <Card className="bg-[rgb(var(--cyber-surface))] border-red-500/30">
              <CardHeader>
                <CardTitle className="text-red-500 flex items-center gap-2">
                  <Shield className="h-5 w-5" />
                  Security Remediation
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <h3 className="text-readable font-semibold mb-2">Identifizierte Schwachstellen:</h3>
                  <ul className="list-disc list-inside space-y-1 text-readable-dim">
                    {containerEscapeRemediation.vulnerabilities.map((vuln, idx) => (
                      <li key={idx}>{vuln}</li>
                    ))}
                  </ul>
                </div>
                <div>
                  <h3 className="text-readable font-semibold mb-2">Empfohlene Maßnahmen:</h3>
                  <ul className="list-disc list-inside space-y-1 text-readable-dim">
                    {containerEscapeRemediation.remediations.map((rec, idx) => (
                      <li key={idx}>{rec}</li>
                    ))}
                  </ul>
                </div>
              </CardContent>
            </Card>

            <Button
              onClick={handleReset}
              className="w-full bg-[rgb(var(--cyber-surface))] border border-[rgb(var(--cyber-cyan))]/30 text-readable hover:bg-[rgb(var(--cyber-surface-light))]"
            >
              Erneut versuchen
            </Button>
          </div>
        )}
      </div>
    </div>
  )
}
